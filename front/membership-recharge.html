<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会员卡充值 - 中医小儿推拿管理系统</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- 添加认证工具脚本 -->
    <script src="js/utils/auth.js"></script>
    <script>
        // 页面加载时检查是否已登录
        document.addEventListener('DOMContentLoaded', function() {
            // 使用认证工具检查登录状态
            authUtils.checkAuth();
        });
    </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="images/logo.png" alt="系统logo" class="img-fluid mb-3" style="max-width: 120px;">
                        <h5>中医小儿推拿管理系统</h5>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="bi bi-house-door me-2"></i>首页
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="customer.html">
                                <i class="bi bi-people me-2"></i>客户档案管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="membership.html">
                                <i class="bi bi-credit-card me-2"></i>会员办卡系统
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="service.html">
                                <i class="bi bi-journal-text me-2"></i>服务记录模块
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="statistics.html">
                                <i class="bi bi-bar-chart me-2"></i>统计与数据分析
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="therapist.html">
                                <i class="bi bi-person-badge me-2"></i>医师管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="inventory.html">
                                <i class="bi bi-box-seam me-2"></i>库存管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="settings.html">
                                <i class="bi bi-gear me-2"></i>系统设置
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">会员卡充值</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <a href="javascript:history.back()" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-left-circle me-1"></i> 返回
                        </a>
                    </div>
                </div>

                <!-- 会员卡基本信息卡片 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="bi bi-credit-card-2-front me-2"></i>会员卡信息</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span class="fw-bold">卡号：</span>
                                        <span id="cardNumber">MK202310001</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span class="fw-bold">客户姓名：</span>
                                        <span id="customerName">王小明</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span class="fw-bold">卡类型：</span>
                                        <span id="cardType">次卡</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span class="fw-bold">剩余次数：</span>
                                        <span id="remainingCount">15次</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span class="fw-bold">剩余金额：</span>
                                        <span id="remainingBalance">¥500.00</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span class="fw-bold">有效期至：</span>
                                        <span id="expiryDate">2024-10-01</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 充值表单 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-cash-coin me-2"></i>充值信息</h5>
                    </div>
                    <div class="card-body">
                        <form id="rechargeForm">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="rechargeType" class="form-label">充值类型</label>
                                        <select class="form-select" id="rechargeType" name="rechargeType" required>
                                            <option value="" selected disabled>请选择充值类型...</option>
                                            <option value="count">次数充值</option>
                                            <option value="amount">金额充值</option>
                                            <option value="extend">延长有效期</option>
                                            <option value="mixed">综合充值</option>
                                        </select>
                                    </div>

                                    <!-- 次数充值选项 -->
                                    <div id="countRechargeOptions" class="mb-3 d-none">
                                        <label for="rechargeCount" class="form-label">充值次数</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="rechargeCount" name="rechargeCount" min="1" placeholder="请输入充值次数">
                                            <span class="input-group-text">次</span>
                                        </div>
                                    </div>

                                    <!-- 金额充值选项 -->
                                    <div id="amountRechargeOptions" class="mb-3 d-none">
                                        <label for="rechargeAmount" class="form-label">充值金额</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¥</span>
                                            <input type="number" class="form-control" id="rechargeAmount" name="rechargeAmount" min="1" step="0.01" placeholder="请输入充值金额">
                                        </div>
                                    </div>

                                    <!-- 延长有效期选项 -->
                                    <div id="extendRechargeOptions" class="mb-3 d-none">
                                        <label for="extendMonths" class="form-label">延长有效期</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="extendMonths" name="extendMonths" min="1" placeholder="请输入延长月数">
                                            <span class="input-group-text">个月</span>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="paymentMethod" class="form-label">支付方式</label>
                                        <select class="form-select" id="paymentMethod" name="paymentMethod" required>
                                            <option value="" selected disabled>请选择支付方式...</option>
                                            <option value="cash">现金</option>
                                            <option value="wechat">微信支付</option>
                                            <option value="alipay">支付宝</option>
                                            <option value="card">银行卡</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <!-- 支付金额汇总 -->
                                    <div class="card mb-3 bg-light">
                                        <div class="card-body">
                                            <h5 class="card-title">支付金额</h5>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span>次数充值：</span>
                                                <span id="countCost">¥0.00</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span>金额充值：</span>
                                                <span id="amountCost">¥0.00</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span>延长有效期：</span>
                                                <span id="extendCost">¥0.00</span>
                                            </div>
                                            <hr>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="fw-bold">总金额：</span>
                                                <span class="fw-bold" id="totalCost">¥0.00</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 操作员信息 -->
                                    <div class="mb-3">
                                        <label for="operatorName" class="form-label">操作员</label>
                                        <input type="text" class="form-control" id="operatorName" name="operatorName" readonly>
                                    </div>

                                    <!-- 备注信息 -->
                                    <div class="mb-3">
                                        <label for="notes" class="form-label">备注</label>
                                        <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="请输入备注信息..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- 充值预览 -->
                            <div class="card mb-4 bg-light">
                                <div class="card-header">
                                    <h6 class="mb-0">充值后会员卡信息预览</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span class="fw-bold">剩余次数：</span>
                                                <span id="previewCount">15次</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span class="fw-bold">剩余金额：</span>
                                                <span id="previewBalance">¥500.00</span>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="d-flex justify-content-between mb-2">
                                                <span class="fw-bold">有效期至：</span>
                                                <span id="previewExpiry">2024-10-01</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" onclick="history.back()">取消</button>
                                <button type="submit" class="btn btn-success" id="submitRechargeBtn">
                                    <i class="bi bi-check-circle me-1"></i> 确认充值
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 充值须知 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-info-circle me-2"></i>充值须知</h5>
                    </div>
                    <div class="card-body">
                        <ol>
                            <li>充值操作一旦完成，无法撤销，请确认信息无误后再提交。</li>
                            <li>会员卡有效期按自然月计算，例如延长1个月是从原有效期算起。</li>
                            <li>次数卡充值后，原有次数和新增次数会自动合并。</li>
                            <li>金额卡充值后，原有金额和新增金额会自动合并。</li>
                            <li>如有特殊需求，请在备注中说明或联系管理员。</li>
                        </ol>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 充值成功提示模态框 -->
    <div class="modal fade" id="rechargeSuccessModal" tabindex="-1" aria-labelledby="rechargeSuccessModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="rechargeSuccessModalLabel">充值成功</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        <h4 class="mt-3">充值已成功完成！</h4>
                    </div>
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <p class="mb-1"><strong>卡号：</strong> <span id="successCardNumber"></span></p>
                                    <p class="mb-1"><strong>客户：</strong> <span id="successCustomerName"></span></p>
                                </div>
                                <div class="col-6">
                                    <p class="mb-1"><strong>充值金额：</strong> <span id="successAmount"></span></p>
                                    <p class="mb-1"><strong>支付方式：</strong> <span id="successPayment"></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <p class="text-center">充值信息已保存，客户可以立即使用会员卡。</p>
                </div>
                <div class="modal-footer">
                    <a href="#" class="btn btn-primary" id="viewCardDetailsBtn">查看卡详情</a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh.js"></script>
    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取会员卡ID
            const urlParams = new URLSearchParams(window.location.search);
            const cardId = urlParams.get('id');
            
            if (!cardId) {
                // 显示错误消息
                document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-danger">未找到会员卡信息，请返回<a href="membership.html">会员卡列表</a>重试。</div></div>';
                return;
            }
            
            // 设置操作员名称
            document.getElementById('operatorName').value = authUtils.getUserDisplayName();
            
            // 更新查看卡详情按钮链接
            document.getElementById('viewCardDetailsBtn').href = `membership-detail.html?id=${cardId}`;
            
            // 获取会员卡详情
            loadCardDetails(cardId);
            
            // 绑定充值类型切换事件
            document.getElementById('rechargeType').addEventListener('change', function() {
                updateRechargeOptions(this.value);
            });
            
            // 绑定充值次数变化事件
            document.getElementById('rechargeCount').addEventListener('input', updateCostPreview);
            
            // 绑定充值金额变化事件
            document.getElementById('rechargeAmount').addEventListener('input', updateCostPreview);
            
            // 绑定延长月数变化事件
            document.getElementById('extendMonths').addEventListener('input', updateCostPreview);
            
            // 绑定表单提交事件
            document.getElementById('rechargeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitRecharge(cardId);
            });
        });
        
        // 加载会员卡详情
        async function loadCardDetails(cardId) {
            try {
                // 从API获取会员卡详情
                const response = await fetch(`http://localhost:5201/api/memberships/${cardId}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    // 更新页面上的会员卡信息
                    updateCardInfo(result.data);
                    
                    // 保存卡信息到本地存储，以便后续使用
                    sessionStorage.setItem('currentCard', JSON.stringify(result.data));
                } else {
                    // 显示错误消息
                    showErrorMessage('获取会员卡详情失败：' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('获取会员卡详情出错:', error);
                showErrorMessage('获取会员卡详情时发生错误，请稍后重试。');
            }
        }
        
        // 更新会员卡信息
        function updateCardInfo(card) {
            // 更新基本信息
            document.getElementById('cardNumber').textContent = card.cardNumber || '';
            document.getElementById('customerName').textContent = card.customer ? (card.customer.childName || '') : '';
            document.getElementById('cardType').textContent = getCardTypeName(card.cardType) || '';
            document.getElementById('remainingCount').textContent = (card.count !== undefined ? `${card.count}次` : '不适用');
            document.getElementById('remainingBalance').textContent = (card.balance !== undefined ? `¥${card.balance.toFixed(2)}` : '¥0.00');
            document.getElementById('expiryDate').textContent = formatDate(card.expiryDate) || '';
            
            // 更新预览信息
            document.getElementById('previewCount').textContent = (card.count !== undefined ? `${card.count}次` : '不适用');
            document.getElementById('previewBalance').textContent = (card.balance !== undefined ? `¥${card.balance.toFixed(2)}` : '¥0.00');
            document.getElementById('previewExpiry').textContent = formatDate(card.expiryDate) || '';
        }
        
        // 获取卡类型名称
        function getCardTypeName(cardType) {
            const typeMap = {
                'count': '次卡',
                'value': '储值卡',
                'period': '期限卡',
                'mixed': '混合卡'
            };
            return typeMap[cardType] || cardType;
        }
        
        // 更新充值选项显示
        function updateRechargeOptions(type) {
            // 隐藏所有选项
            document.getElementById('countRechargeOptions').classList.add('d-none');
            document.getElementById('amountRechargeOptions').classList.add('d-none');
            document.getElementById('extendRechargeOptions').classList.add('d-none');
            
            // 根据类型显示对应选项
            switch (type) {
                case 'count':
                    document.getElementById('countRechargeOptions').classList.remove('d-none');
                    document.getElementById('rechargeCount').setAttribute('required', '');
                    document.getElementById('rechargeAmount').removeAttribute('required');
                    document.getElementById('extendMonths').removeAttribute('required');
                    break;
                case 'amount':
                    document.getElementById('amountRechargeOptions').classList.remove('d-none');
                    document.getElementById('rechargeAmount').setAttribute('required', '');
                    document.getElementById('rechargeCount').removeAttribute('required');
                    document.getElementById('extendMonths').removeAttribute('required');
                    break;
                case 'extend':
                    document.getElementById('extendRechargeOptions').classList.remove('d-none');
                    document.getElementById('extendMonths').setAttribute('required', '');
                    document.getElementById('rechargeCount').removeAttribute('required');
                    document.getElementById('rechargeAmount').removeAttribute('required');
                    break;
                case 'mixed':
                    document.getElementById('countRechargeOptions').classList.remove('d-none');
                    document.getElementById('amountRechargeOptions').classList.remove('d-none');
                    document.getElementById('extendRechargeOptions').classList.remove('d-none');
                    break;
            }
            
            // 更新费用预览
            updateCostPreview();
        }
        
        // 更新费用预览
        function updateCostPreview() {
            // 获取充值参数
            const rechargeType = document.getElementById('rechargeType').value;
            
            // 获取次数和单价
            const countEl = document.getElementById('rechargeCount');
            const count = countEl.value ? parseInt(countEl.value) : 0;
            const countPrice = 40; // 假设每次40元
            const countCost = count * countPrice;
            
            // 获取金额充值
            const amountEl = document.getElementById('rechargeAmount');
            const amountCost = amountEl.value ? parseFloat(amountEl.value) : 0;
            
            // 获取延长月数和单价
            const monthsEl = document.getElementById('extendMonths');
            const months = monthsEl.value ? parseInt(monthsEl.value) : 0;
            const monthPrice = 50; // 假设每月50元
            const extendCost = months * monthPrice;
            
            // 更新费用显示
            document.getElementById('countCost').textContent = `¥${countCost.toFixed(2)}`;
            document.getElementById('amountCost').textContent = `¥${amountCost.toFixed(2)}`;
            document.getElementById('extendCost').textContent = `¥${extendCost.toFixed(2)}`;
            
            // 计算总费用
            let totalCost = 0;
            
            switch (rechargeType) {
                case 'count':
                    totalCost = countCost;
                    break;
                case 'amount':
                    totalCost = amountCost;
                    break;
                case 'extend':
                    totalCost = extendCost;
                    break;
                case 'mixed':
                    totalCost = countCost + amountCost + extendCost;
                    break;
            }
            
            document.getElementById('totalCost').textContent = `¥${totalCost.toFixed(2)}`;
            
            // 更新预览信息
            updateCardPreview(count, amountCost, months);
        }
        
        // 更新卡预览信息
        function updateCardPreview(addCount, addAmount, addMonths) {
            // 获取当前卡信息
            const cardJson = sessionStorage.getItem('currentCard');
            if (!cardJson) return;
            
            const card = JSON.parse(cardJson);
            
            // 计算新的次数
            let newCount = card.count;
            if (typeof newCount === 'number') {
                newCount += addCount;
                document.getElementById('previewCount').textContent = `${newCount}次`;
            }
            
            // 计算新的金额
            let newBalance = card.balance;
            if (typeof newBalance === 'number') {
                newBalance += addAmount;
                document.getElementById('previewBalance').textContent = `¥${newBalance.toFixed(2)}`;
            }
            
            // 计算新的有效期
            if (card.expiryDate && addMonths > 0) {
                const expiryDate = new Date(card.expiryDate);
                expiryDate.setMonth(expiryDate.getMonth() + addMonths);
                document.getElementById('previewExpiry').textContent = formatDate(expiryDate);
            }
        }
        
        // 提交充值
        async function submitRecharge(cardId) {
            // 获取表单数据
            const rechargeType = document.getElementById('rechargeType').value;
            const rechargeCount = document.getElementById('rechargeCount').value ? parseInt(document.getElementById('rechargeCount').value) : 0;
            const rechargeAmount = document.getElementById('rechargeAmount').value ? parseFloat(document.getElementById('rechargeAmount').value) : 0;
            const extendMonths = document.getElementById('extendMonths').value ? parseInt(document.getElementById('extendMonths').value) : 0;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const notes = document.getElementById('notes').value;
            
            // 验证表单
            if (!rechargeType) {
                alert('请选择充值类型');
                return;
            }
            
            if (!paymentMethod) {
                alert('请选择支付方式');
                return;
            }
            
            // 验证充值数据
            let isValid = true;
            let totalAmount = 0;
            
            switch (rechargeType) {
                case 'count':
                    if (rechargeCount <= 0) {
                        alert('请输入有效的充值次数');
                        isValid = false;
                    }
                    totalAmount = rechargeCount * 40; // 假设每次40元
                    break;
                case 'amount':
                    if (rechargeAmount <= 0) {
                        alert('请输入有效的充值金额');
                        isValid = false;
                    }
                    totalAmount = rechargeAmount;
                    break;
                case 'extend':
                    if (extendMonths <= 0) {
                        alert('请输入有效的延长月数');
                        isValid = false;
                    }
                    totalAmount = extendMonths * 50; // 假设每月50元
                    break;
                case 'mixed':
                    if (rechargeCount <= 0 && rechargeAmount <= 0 && extendMonths <= 0) {
                        alert('请至少输入一项有效的充值数据');
                        isValid = false;
                    }
                    totalAmount = rechargeCount * 40 + rechargeAmount + extendMonths * 50;
                    break;
            }
            
            if (!isValid) return;
            
            // 准备请求数据
            const rechargeData = {
                rechargeType: rechargeType,
                count: rechargeCount,
                amount: rechargeAmount,
                extendMonths: extendMonths,
                totalAmount: totalAmount,
                paymentMethod: paymentMethod,
                notes: notes,
                operatorName: authUtils.getUserDisplayName()
            };
            
            // 禁用提交按钮
            const submitBtn = document.getElementById('submitRechargeBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...';
            
            try {
                // 调用API提交充值
                const response = await fetch(`http://localhost:5201/api/memberships/${cardId}/recharge`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    body: JSON.stringify(rechargeData)
                });
                
                const result = await response.json();
                
                // 恢复提交按钮
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i> 确认充值';
                
                if (result.success) {
                    // 更新成功模态框信息
                    document.getElementById('successCardNumber').textContent = document.getElementById('cardNumber').textContent;
                    document.getElementById('successCustomerName').textContent = document.getElementById('customerName').textContent;
                    document.getElementById('successAmount').textContent = `¥${totalAmount.toFixed(2)}`;
                    
                    // 支付方式映射
                    const paymentMap = {
                        'cash': '现金',
                        'wechat': '微信支付',
                        'alipay': '支付宝',
                        'card': '银行卡'
                    };
                    document.getElementById('successPayment').textContent = paymentMap[paymentMethod] || paymentMethod;
                    
                    // 显示成功模态框
                    const successModal = new bootstrap.Modal(document.getElementById('rechargeSuccessModal'));
                    successModal.show();
                } else {
                    alert('充值失败：' + (result.message || '未知错误'));
                }
            } catch (error) {
                console.error('充值出错:', error);
                alert('充值时发生错误，请稍后重试');
                
                // 恢复提交按钮
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-1"></i> 确认充值';
            }
        }
        
        // 显示错误消息
        function showErrorMessage(message) {
            const alertHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            
            document.querySelector('main').insertAdjacentHTML('afterbegin', alertHtml);
        }
        
        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
        }
    </script>
</body>
</html> 