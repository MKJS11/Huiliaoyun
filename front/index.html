<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中医小儿推拿管理系统</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- 添加认证工具脚本 -->
    <script src="js/utils/auth.js"></script>
    <script>
        // 页面加载时检查是否已登录
        document.addEventListener('DOMContentLoaded', function() {
            // 使用认证工具检查登录状态
            authUtils.checkAuth();
            
            // 更新用户信息显示
            document.getElementById('userDisplayName').textContent = authUtils.getUserDisplayName();
            document.getElementById('userRole').textContent = authUtils.getUserRole() || '';
            
            // 绑定退出登录按钮事件
            document.getElementById('logoutBtn').addEventListener('click', function(e) {
                e.preventDefault();
                authUtils.logout();
            });
        });
    </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- 侧边栏 -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <img src="images/logo.png" alt="系统logo" class="img-fluid mb-3" style="max-width: 120px;">
                        <h5>中医小儿推拿管理系统</h5>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="index.html">
                                <i class="bi bi-house-door me-2"></i>首页
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="customer.html">
                                <i class="bi bi-people me-2"></i>客户档案管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="membership.html">
                                <i class="bi bi-credit-card me-2"></i>会员办卡系统
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="service.html">
                                <i class="bi bi-journal-text me-2"></i>服务记录模块
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="statistics.html">
                                <i class="bi bi-bar-chart me-2"></i>统计与数据分析
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="therapist.html">
                                <i class="bi bi-person-badge me-2"></i>医师管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="inventory.html">
                                <i class="bi bi-box-seam me-2"></i>库存管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="settings.html">
                                <i class="bi bi-gear me-2"></i>系统设置
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- 主内容区 -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">系统概览</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-person-circle me-1"></i>
                                <span id="userDisplayName">用户</span>
                                <small class="text-muted ms-1" id="userRole"></small>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="settings.html"><i class="bi bi-gear me-2"></i>个人设置</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="bi bi-box-arrow-right me-2"></i>退出登录</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 快捷入口卡片 -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <i class="bi bi-person-plus-fill fs-1 text-primary mb-3"></i>
                                <h5 class="card-title">新增客户</h5>
                                <p class="card-text">快速添加新的客户档案信息</p>
                                <a href="customer-add.html" class="btn btn-primary">立即添加</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <i class="bi bi-credit-card-2-front fs-1 text-success mb-3"></i>
                                <h5 class="card-title">会员办卡</h5>
                                <p class="card-text">为客户办理新的会员卡或续费</p>
                                <a href="membership-add.html" class="btn btn-success">办理会员</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <i class="bi bi-clipboard2-plus fs-1 text-info mb-3"></i>
                                <h5 class="card-title">服务记录</h5>
                                <p class="card-text">记录新的小儿推拿服务</p>
                                <a href="service-add.html" class="btn btn-info text-white">记录服务</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100">
                            <div class="card-body">
                                <i class="bi bi-person-badge fs-1 text-warning mb-3"></i>
                                <h5 class="card-title">医师管理</h5>
                                <p class="card-text">管理推拿医师信息与绩效</p>
                                <a href="therapist.html" class="btn btn-warning text-dark">管理医师</a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 数据概览 -->
                <h4 class="mb-3">今日概览</h4>
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card border-left-primary h-100">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col-auto">
                                        <i class="bi bi-person-walking fs-2 text-primary me-3"></i>
                                    </div>
                                    <div class="col">
                                        <div class="text-xs text-muted">今日客流量</div>
                                        <div class="h5 mb-0 font-weight-bold">28人次</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-left-success h-100">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col-auto">
                                        <i class="bi bi-currency-yen fs-2 text-success me-3"></i>
                                    </div>
                                    <div class="col">
                                        <div class="text-xs text-muted">今日营收</div>
                                        <div class="h5 mb-0 font-weight-bold">￥3,680</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-left-info h-100">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col-auto">
                                        <i class="bi bi-person-add fs-2 text-info me-3"></i>
                                    </div>
                                    <div class="col">
                                        <div class="text-xs text-muted">新增会员</div>
                                        <div class="h5 mb-0 font-weight-bold">5人</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-left-warning h-100">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col-auto">
                                        <i class="bi bi-exclamation-triangle fs-2 text-warning me-3"></i>
                                    </div>
                                    <div class="col">
                                        <div class="text-xs text-muted">卡到期提醒</div>
                                        <div class="h5 mb-0 font-weight-bold">12张</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 营收趋势图 -->
                <div class="row mb-4">
                    <div class="col-md-8 mb-3">
                        <div class="card h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="m-0 font-weight-bold">近7日营收趋势</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="revenueDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        过去7天
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="revenueDropdown">
                                        <li><a class="dropdown-item" href="#">过去7天</a></li>
                                        <li><a class="dropdown-item" href="#">过去30天</a></li>
                                        <li><a class="dropdown-item" href="#">自定义...</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height: 300px; width: 100%;">
                                    <canvas id="revenueChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="m-0 font-weight-bold">今日预约</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush">
                                    <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                        <div>
                                            <h6 class="mb-0">李小明</h6>
                                            <small class="text-muted">10:30 - 张医师</small>
                                        </div>
                                        <span class="badge bg-primary rounded-pill">进行中</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                        <div>
                                            <h6 class="mb-0">王小花</h6>
                                            <small class="text-muted">14:00 - 刘医师</small>
                                        </div>
                                        <span class="badge bg-warning text-dark rounded-pill">待确认</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                        <div>
                                            <h6 class="mb-0">赵小刚</h6>
                                            <small class="text-muted">15:30 - 王医师</small>
                                        </div>
                                        <span class="badge bg-success rounded-pill">已确认</span>
                                    </div>
                                    <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                        <div>
                                            <h6 class="mb-0">张小丽</h6>
                                            <small class="text-muted">16:45 - 李医师</small>
                                        </div>
                                        <span class="badge bg-success rounded-pill">已确认</span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer text-center">
                                <a href="appointments.html" class="text-decoration-none">查看所有预约 <i class="bi bi-arrow-right-short"></i></a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 快速提醒区 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold">需要关注</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="alert alert-warning mb-0" role="alert">
                                    <h6 class="alert-heading"><i class="bi bi-exclamation-circle me-2"></i>库存预警</h6>
                                    <p class="mb-0">3种商品库存低于阈值，<a href="inventory.html" class="alert-link">点击查看详情</a></p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="alert alert-info mb-0" role="alert">
                                    <h6 class="alert-heading"><i class="bi bi-bell me-2"></i>客户召回</h6>
                                    <p class="mb-0">8名客户超过30天未到店，<a href="customer-inactive.html" class="alert-link">查看召回名单</a></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 使用特定版本的Chart.js，并设置crossorigin属性 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js" crossorigin="anonymous"></script>
    <script src="js/main.js"></script>
    <script>
        // 声明全局图表变量，以便后续更新
        let revenueChart;
        
        // 初始化营收趋势图
        function initRevenueChart(labels = [], data = []) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // 如果图表已存在，先销毁
            if (revenueChart) {
                revenueChart.destroy();
            }
            
            // 确保有默认的标签和数据
            if (labels.length === 0 || data.length === 0) {
                const today = new Date();
                for (let i = 0; i < 7; i++) {
                    const date = new Date();
                    date.setDate(today.getDate() - 6 + i);
                    labels.push(`${date.getMonth() + 1}月${date.getDate()}日`);
                    data.push(0);
                }
            }
            
            // 确保labels和data长度匹配
            const dataLength = Math.min(labels.length, data.length);
            const finalLabels = labels.slice(0, dataLength);
            const finalData = data.slice(0, dataLength);
            
            // 寻找合适的Y轴最大值
            let maxValue = Math.max(...finalData, 0);
            if (maxValue === 0) maxValue = 5000; // 默认值
            
            // 设置固定步长为100
            const stepSize = 100;
            
            // 向上取整到最接近的步长的倍数
            const ceiling = Math.ceil(maxValue / stepSize) * stepSize;
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: finalLabels,
                    datasets: [{
                        label: '日营收(元)',
                        data: finalData,
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                        pointBorderColor: '#fff',
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                        pointHoverBorderWidth: 2,
                        pointRadius: 4,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            right: 25,
                            bottom: 10,
                            left: 15
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: ceiling,
                            ticks: {
                                // 回调函数格式化Y轴标签为货币
                                callback: function(value) {
                                    return '¥' + value.toLocaleString('zh-CN');
                                },
                                stepSize: stepSize,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                drawBorder: false,
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#495057',
                            bodyColor: '#495057',
                            borderColor: '#ced4da',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                // 格式化提示框中的金额
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '¥' + context.parsed.y.toLocaleString('zh-CN');
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 获取近7日营收趋势数据
        async function fetchRevenueData(days = 7) {
            try {
                // 显示加载中状态
                document.getElementById('revenueChart').style.opacity = '0.5';
                
                // 从API获取数据
                const response = await fetch(`http://localhost:5201/api/statistics/revenue-trend?days=${days}`);
                const result = await response.json();
                
                // 恢复正常显示
                document.getElementById('revenueChart').style.opacity = '1';
                
                if (result.success && result.data) {
                    // 处理日期格式
                    const labels = result.data.dates.map(date => {
                        const dateObj = new Date(date);
                        return `${dateObj.getMonth() + 1}月${dateObj.getDate()}日`;
                    });
                    
                    // 更新图表
                    initRevenueChart(labels, result.data.revenues);
                    
                    // 更新下拉菜单标题
                    document.getElementById('revenueDropdown').textContent = `过去${days}天`;
                } else {
                    console.error('获取营收趋势数据失败:', result.message);
                    // 使用默认数据初始化图表，确保UI可见
                    const defaultLabels = [];
                    const defaultData = [];
                    
                    // 生成当前月份的日期作为默认数据
                    const today = new Date();
                    for (let i = 0; i < days; i++) {
                        const date = new Date();
                        date.setDate(today.getDate() - days + i + 1);
                        defaultLabels.push(`${date.getMonth() + 1}月${date.getDate()}日`);
                        defaultData.push(Math.floor(Math.random() * 5000) + 1000); // 随机样本数据
                    }
                    
                    initRevenueChart(defaultLabels, defaultData);
                }
            } catch (error) {
                console.error('获取营收趋势数据出错:', error);
                // 恢复正常显示
                document.getElementById('revenueChart').style.opacity = '1';
                
                // 使用默认数据初始化图表
                const defaultLabels = [];
                const defaultData = [];
                
                // 生成当前月份的日期作为默认数据
                const today = new Date();
                for (let i = 0; i < days; i++) {
                    const date = new Date();
                    date.setDate(today.getDate() - days + i + 1);
                    defaultLabels.push(`${date.getMonth() + 1}月${date.getDate()}日`);
                    defaultData.push(Math.floor(Math.random() * 5000) + 1000); // 随机样本数据
                }
                
                initRevenueChart(defaultLabels, defaultData);
                
                // 在控制台显示错误，不打断用户体验
                console.error('加载营收趋势数据失败，请检查网络连接或API状态');
            }
        }

        // 获取今日概览数据
        async function fetchTodayOverview() {
            try {
                const response = await fetch('http://localhost:5201/api/statistics/today-overview');
                const result = await response.json();
                
                if (result.success && result.data) {
                    updateOverviewCards(result.data);
                } else {
                    console.error('获取今日概览数据失败:', result.message);
                }
            } catch (error) {
                console.error('获取今日概览数据出错:', error);
            }
        }

        // 更新概览卡片
        function updateOverviewCards(data) {
            // 今日客流量
            const visitsEl = document.querySelector('.row.mb-4 .col-md-3:nth-child(1) .h5');
            if (visitsEl) {
                visitsEl.textContent = `${data.todayVisits}人次`;
            }
            
            // 今日营收
            const revenueEl = document.querySelector('.row.mb-4 .col-md-3:nth-child(2) .h5');
            if (revenueEl) {
                revenueEl.textContent = `￥${formatCurrency(data.todayRevenue)}`;
            }
            
            // 新增会员
            const membersEl = document.querySelector('.row.mb-4 .col-md-3:nth-child(3) .h5');
            if (membersEl) {
                membersEl.textContent = `${data.todayNewMembers}人`;
            }
            
            // 卡到期提醒
            const expiringEl = document.querySelector('.row.mb-4 .col-md-3:nth-child(4) .h5');
            if (expiringEl) {
                expiringEl.textContent = `${data.expiringCards}张`;
            }
        }

        // 格式化货币数字
        function formatCurrency(value) {
            return new Intl.NumberFormat('zh-CN').format(value);
        }

        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', function() {
            // 获取今日概览数据
            fetchTodayOverview();
            
            // 获取近7日营收趋势
            fetchRevenueData(7);
            
            // 绑定时间范围选择事件
            document.querySelectorAll('.dropdown-menu[aria-labelledby="revenueDropdown"] .dropdown-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const text = this.textContent.trim();
                    let days = 7;
                    
                    if (text.includes('30')) {
                        days = 30;
                    } else if (text.includes('自定义')) {
                        // 这里可以添加自定义日期范围的对话框
                        // 简化处理，暂时使用90天
                        days = 90;
                    }
                    
                    fetchRevenueData(days);
                });
            });
        });
    </script>
</body>
</html> 