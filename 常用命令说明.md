# 中医小儿推拿管理系统 - 常用命令说明

## 📋 目录

- [1. 项目结构](#1-项目结构)
- [2. 开发环境命令](#2-开发环境命令)
- [3. 生产环境命令](#3-生产环境命令)
- [4. 数据库管理命令](#4-数据库管理命令)
- [5. 服务器管理命令](#5-服务器管理命令)
- [6. 日志查看命令](#6-日志查看命令)
- [7. 备份与恢复命令](#7-备份与恢复命令)
- [8. 故障排查命令](#8-故障排查命令)
- [9. 安全与监控命令](#9-安全与监控命令)
- [10. Git版本控制命令](#10-git版本控制命令)

---

## 1. 项目结构

```
p1/
├── @back/                    # 后端目录
│   ├── config/              # 配置文件
│   ├── controllers/         # 控制器
│   ├── models/             # 数据模型
│   ├── routes/             # 路由
│   ├── middlewares/        # 中间件
│   ├── server.js           # 主服务器文件
│   ├── package.json        # 后端依赖配置
│   └── .env               # 环境变量
├── front/                   # 前端目录
│   ├── css/               # 样式文件
│   ├── js/                # JavaScript文件
│   ├── images/            # 图片资源
│   ├── *.html             # 页面文件
│   └── package.json       # 前端依赖配置
├── deployment.md           # 部署文档
├── nginx.conf             # Nginx配置
└── 常用命令说明.md        # 本文档
```

---

## 2. 开发环境命令

### 🔧 环境准备

```bash
# 检查Node.js版本
node -v
npm -v

# 检查MongoDB状态
systemctl status mongod
# 或 macOS使用 Homebrew
brew services list | grep mongodb

# 安装后端依赖
cd @back
npm install

# 安装前端依赖（如果有）
cd front
npm install
```

### 🚀 启动开发服务

```bash
# 启动后端服务（开发模式）
cd @back
npm run dev
# 或直接运行
nodemon server.js

# 启动后端服务（生产模式）
npm start
# 或直接运行
node server.js

# 启动前端开发服务器（如果配置了）
cd front
./start.sh
# 或
node start-server.js
```

### 🔍 开发调试

```bash
# 查看实时日志
cd @back
npm run dev | tee logs/dev.log

# 检查端口占用
lsof -i :5201  # 后端端口
lsof -i :8080  # 前端端口

# 重启服务
# Ctrl+C 停止服务，然后重新启动
```

---

## 3. 生产环境命令

### 🌐 PM2 进程管理

```bash
# 启动应用
pm2 start @back/server.js --name "huiliaoyun-backend"

# 查看所有应用状态
pm2 status
pm2 list

# 重启应用
pm2 restart huiliaoyun-backend
pm2 restart all

# 停止应用
pm2 stop huiliaoyun-backend
pm2 stop all

# 删除应用（从PM2管理中移除）
pm2 delete huiliaoyun-backend

# 查看应用详细信息
pm2 show huiliaoyun-backend

# 监控应用
pm2 monit

# 查看日志
pm2 logs huiliaoyun-backend
pm2 logs --lines 100

# 清空日志
pm2 flush

# 保存PM2配置
pm2 save

# 设置开机自启
pm2 startup
pm2 save
```

### 🔄 应用更新部署

```bash
# 拉取最新代码
git pull origin main

# 安装新依赖（如果有）
cd @back
npm install --production

# 重启应用
pm2 restart huiliaoyun-backend

# 检查更新状态
pm2 status
pm2 logs huiliaoyun-backend --lines 50
```

---

## 4. 数据库管理命令

### 🗄️ MongoDB 基础操作

```bash
# 启动MongoDB服务
sudo systemctl start mongod
# macOS
brew services start mongodb-community

# 停止MongoDB服务
sudo systemctl stop mongod
# macOS
brew services stop mongodb-community

# 重启MongoDB服务
sudo systemctl restart mongod

# 查看MongoDB状态
sudo systemctl status mongod

# 连接到MongoDB
mongosh
# 或使用认证连接
mongosh -u huiliaoyun -p k87y6gjyf656 huiliaoyun
```

### 📊 数据库操作

```bash
# 连接到数据库后的操作
mongosh huiliaoyun

# 查看所有数据库
show dbs

# 使用指定数据库
use huiliaoyun

# 查看所有集合
show collections

# 查看集合文档数量
db.customers.countDocuments()
db.services.countDocuments()
db.memberships.countDocuments()

# 查看最近的记录
db.customers.find().sort({createdAt: -1}).limit(5)

# 创建索引（优化查询性能）
db.customers.createIndex({phone: 1})
db.services.createIndex({customerId: 1, date: -1})

# 查看索引
db.customers.getIndexes()
```

### 🔒 用户权限管理

```bash
# 创建管理员用户
mongosh admin --eval '
  db.createUser({
    user: "admin",
    pwd: "jzh627200", 
    roles: [ { role: "userAdminAnyDatabase", db: "admin" } ]
  })
'

# 创建应用数据库用户
mongosh admin -u admin -p jzh627200 --eval '
  db.createUser({
    user: "huiliaoyun",
    pwd: "k87y6gjyf656",
    roles: [ { role: "readWrite", db: "huiliaoyun" } ]
  })
'

# 修改用户密码
mongosh -u admin -p jzh627200 admin --eval '
  db.changeUserPassword("huiliaoyun", "新密码")
'
```

---

## 5. 服务器管理命令

### 🌐 Nginx 服务管理

```bash
# 启动Nginx
sudo systemctl start nginx

# 重启Nginx
sudo systemctl restart nginx

# 重新加载配置（不中断服务）
sudo systemctl reload nginx
# 或
sudo nginx -s reload

# 停止Nginx
sudo systemctl stop nginx

# 查看Nginx状态
sudo systemctl status nginx

# 检查配置文件语法
sudo nginx -t

# 查看nginx进程
ps aux | grep nginx
```

### ⚙️ Nginx 配置管理

```bash
# 编辑主配置文件
sudo vim /etc/nginx/nginx.conf

# 编辑站点配置
sudo vim /etc/nginx/sites-available/huiliaoyun.conf

# 启用站点配置
sudo ln -s /etc/nginx/sites-available/huiliaoyun.conf /etc/nginx/sites-enabled/

# 禁用站点配置
sudo rm /etc/nginx/sites-enabled/huiliaoyun.conf

# 查看配置文件
cat /etc/nginx/sites-available/huiliaoyun.conf

# 测试配置并重新加载
sudo nginx -t && sudo nginx -s reload
```

### 🔐 SSL证书管理（Let's Encrypt）

```bash
# 获取SSL证书
sudo certbot --nginx -d huiliaoyun.site

# 续期证书
sudo certbot renew

# 测试续期（不会真正续期）
sudo certbot renew --dry-run

# 查看证书状态
sudo certbot certificates

# 撤销证书（谨慎使用）
sudo certbot revoke --cert-path /etc/letsencrypt/live/huiliaoyun.site/cert.pem
```

---

## 6. 日志查看命令

### 📋 应用日志

```bash
# PM2应用日志
pm2 logs huiliaoyun-backend
pm2 logs --lines 100
pm2 logs --timestamp

# 实时查看日志
pm2 logs huiliaoyun-backend --follow

# 查看特定时间的日志
pm2 logs huiliaoyun-backend --timestamp | grep "2024-03-19"
```

### 🌐 Nginx日志

```bash
# 查看访问日志
sudo tail -f /var/log/nginx/huiliaoyun-access.log

# 查看错误日志
sudo tail -f /var/log/nginx/huiliaoyun-error.log

# 查看最近的错误
sudo tail -n 100 /var/log/nginx/error.log

# 分析访问日志
sudo grep "POST /api" /var/log/nginx/huiliaoyun-access.log
sudo grep "5xx" /var/log/nginx/huiliaoyun-access.log
```

### 🗄️ 系统日志

```bash
# 查看系统日志
sudo journalctl -u nginx
sudo journalctl -u mongod

# 查看最近的系统日志
sudo journalctl -f

# 查看特定服务的日志
sudo journalctl -u nginx --since "1 hour ago"
```

---

## 7. 备份与恢复命令

### 💾 数据库备份

```bash
# 完整备份
mongodump --uri="mongodb://huiliaoyun:k87y6gjyf656@localhost:27017/huiliaoyun" --out="/var/backups/mongodb/$(date +%Y%m%d-%H%M%S)"

# 压缩备份
mongodump --uri="mongodb://huiliaoyun:k87y6gjyf656@localhost:27017/huiliaoyun" --gzip --out="/var/backups/mongodb/$(date +%Y%m%d-%H%M%S)"

# 备份特定集合
mongodump --uri="mongodb://huiliaoyun:k87y6gjyf656@localhost:27017/huiliaoyun" --collection=customers --out="/var/backups/mongodb/"

# 创建自动备份脚本
cat > /root/backup-mongodb.sh << 'EOL'
#!/bin/bash
TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
BACKUP_DIR="/var/backups/mongodb"
BACKUP_FILE="$BACKUP_DIR/huiliaoyun-$TIMESTAMP"

mongodump --uri="mongodb://huiliaoyun:k87y6gjyf656@localhost:27017/huiliaoyun" --out="$BACKUP_FILE"
tar -zcf "$BACKUP_FILE.tar.gz" -C "$BACKUP_DIR" "huiliaoyun-$TIMESTAMP"
rm -rf "$BACKUP_FILE"

# 删除7天前的备份
find $BACKUP_DIR -name "*.tar.gz" -type f -mtime +7 -delete
EOL

chmod +x /root/backup-mongodb.sh
```

### 🔄 数据库恢复

```bash
# 恢复完整数据库
mongorestore --uri="mongodb://huiliaoyun:k87y6gjyf656@localhost:27017/huiliaoyun" --drop /path/to/backup/huiliaoyun/

# 恢复特定集合
mongorestore --uri="mongodb://huiliaoyun:k87y6gjyf656@localhost:27017/huiliaoyun" --collection=customers /path/to/backup/huiliaoyun/customers.bson

# 从压缩备份恢复
tar -zxf backup.tar.gz
mongorestore --uri="mongodb://huiliaoyun:k87y6gjyf656@localhost:27017/huiliaoyun" extracted_folder/
```

### 📁 文件备份

```bash
# 备份整个应用目录
tar -zcf /var/backups/huiliaoyun-$(date +%Y%m%d).tar.gz /var/www/huiliaoyun/

# 备份配置文件
cp /etc/nginx/sites-available/huiliaoyun.conf /var/backups/nginx-config-$(date +%Y%m%d).conf

# 同步到远程服务器（如果有）
rsync -avz /var/www/huiliaoyun/ user@backup-server:/backups/huiliaoyun/
```

---

## 8. 故障排查命令

### 🔍 服务状态检查

```bash
# 检查所有关键服务状态
sudo systemctl status nginx
sudo systemctl status mongod
pm2 status

# 检查端口占用
netstat -tlnp | grep :80
netstat -tlnp | grep :443
netstat -tlnp | grep :5201
netstat -tlnp | grep :27017

# 检查进程
ps aux | grep nginx
ps aux | grep mongod
ps aux | grep node
```

### 🚨 错误诊断

```bash
# 检查最近的错误
sudo journalctl --since "1 hour ago" --priority=err
sudo tail -n 50 /var/log/nginx/error.log
pm2 logs --lines 50 --err

# 检查磁盘空间
df -h
du -sh /var/www/huiliaoyun/
du -sh /var/log/

# 检查内存使用
free -h
top -o %MEM

# 检查网络连接
netstat -tuln
ss -tuln
```

### 🔧 性能分析

```bash
# 查看系统负载
uptime
htop

# 查看MongoDB性能
mongosh huiliaoyun --eval "db.serverStatus()"
mongosh huiliaoyun --eval "db.stats()"

# 查看Nginx状态（需要配置status模块）
curl http://localhost/nginx_status

# 分析日志中的慢请求
grep "slow" /var/log/nginx/access.log
```

---

## 9. 安全与监控命令

### 🔒 防火墙管理

```bash
# 查看防火墙状态
sudo ufw status
sudo ufw status verbose

# 开放端口
sudo ufw allow ssh
sudo ufw allow http
sudo ufw allow https
sudo ufw allow 5201  # 如果需要直接访问后端

# 关闭端口
sudo ufw deny 5201

# 启用/禁用防火墙
sudo ufw enable
sudo ufw disable
```

### 🛡️ 安全检查

```bash
# 检查失败的登录尝试
sudo journalctl _SYSTEMD_UNIT=ssh.service | grep "Failed"

# 查看fail2ban状态（如果安装了）
sudo fail2ban-client status
sudo fail2ban-client status sshd

# 检查系统更新
apt list --upgradable
sudo apt update && apt list --upgradable

# 查看监听的端口
sudo ss -tlnp
```

### 📊 系统监控

```bash
# 实时系统监控
htop
# 或
top

# 查看磁盘I/O
iotop

# 查看网络流量
iftop

# 查看系统信息
uname -a
lsb_release -a
cat /proc/version
```

---

## 10. Git版本控制命令

### 📝 代码管理

```bash
# 查看当前状态
git status

# 查看文件差异
git diff
git diff --staged

# 添加文件到暂存区
git add .
git add 特定文件名

# 提交代码
git commit -m "描述信息"

# 推送到远程仓库
git push origin main

# 拉取最新代码
git pull origin main

# 查看提交历史
git log --oneline -10
```

### 🔄 分支管理

```bash
# 查看所有分支
git branch -a

# 创建新分支
git checkout -b 新分支名

# 切换分支
git checkout 分支名

# 合并分支
git checkout main
git merge 分支名

# 删除分支
git branch -d 分支名
```

### 🏷️ 标签管理

```bash
# 创建标签
git tag -a v1.0.0 -m "版本1.0.0"

# 推送标签
git push origin v1.0.0
git push origin --tags

# 查看所有标签
git tag -l

# 切换到特定标签
git checkout v1.0.0
```

---

## 📋 快速故障处理清单

### 🚨 应用无法访问

1. 检查服务状态：`pm2 status`
2. 检查Nginx状态：`sudo systemctl status nginx`
3. 查看错误日志：`pm2 logs` 和 `sudo tail /var/log/nginx/error.log`
4. 检查端口占用：`netstat -tlnp | grep :80`

### 🗄️ 数据库连接问题

1. 检查MongoDB状态：`sudo systemctl status mongod`
2. 测试连接：`mongosh -u huiliaoyun -p k87y6gjyf656 huiliaoyun`
3. 检查配置：`cat @back/.env`
4. 查看MongoDB日志：`sudo journalctl -u mongod`

### 🔐 SSL证书问题

1. 检查证书状态：`sudo certbot certificates`
2. 测试续期：`sudo certbot renew --dry-run`
3. 重新获取证书：`sudo certbot --nginx -d 域名`
4. 检查Nginx配置：`sudo nginx -t`

---

## 💡 最佳实践建议

1. **定期备份**：每日自动备份数据库，每周备份完整应用
2. **监控日志**：定期检查错误日志，及时发现问题
3. **更新系统**：定期更新系统包和依赖包
4. **性能监控**：使用监控工具观察系统性能
5. **安全检查**：定期检查安全日志和失败登录尝试

---

## 📞 技术支持

如遇到问题，请按以下顺序排查：

1. 查看本文档相关命令
2. 检查应用和系统日志
3. 参考 `deployment.md` 部署文档
4. 联系技术支持团队

---

*最后更新：2024年3月19日*
